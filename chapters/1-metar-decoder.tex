\chapter{Decodificação do METAR}

\section{Introdução}
O METAR é um protocolo de transmissão de dados meteorologicos de um aeroporto ou aeródromo.
Não se trata de uma previsão do tempo, mas sim de uma visualização atual.
O METAR é formado por itens separados por espaço. Cada item correponde a uma
unidade mínima de informação meteorológica. Com os dados de sensores instalados no aeródromo\cite{metar-weather-gov}, a
cada hora é publicado um novo METAR que é válido aquela hora. Em casos excepcionais quando o as condições de tempo 
estiverem mudando repentinamente um METAR pode ser atualizado a cada meia hora \cite{METAR-speci} 

\section{Exemplo}
O METAR no aeroporto de Fortaleza \cite{METAR-sbfz}, no dia 17 de abril de 2024 as 10:54 foi
\texttt{171300Z 15010KT 9999 BKN019 SCT025 FEW030TCU BKN100 30/25 Q1011}

"SBFZ" se refere ao código ICAO (International Civil Aviation Organization) do aeroporto, não
confudir com o código IATA (International Air Transport Association) que é formado por três letras.
O aeroporto Pinto Martins possui o código IATA FOR, o Santos Dumont SDU e o Galeão GIG. O público 
geral parece conhecer mais este código, mas na aviação
costuma-se usar mais o código ICAO, pois \textit{todos} os aeródromos possuem um, enquanto o IATA só 
é presente em aeroportos onde há processamento de bagagem \cite{iata-codes} \cite{icao-codes}. 

O ICAO é formado por quatro letras em que a primeira é o prefixo da região.
A América do Sul possui o prefixo "S",
o Brasil possui o prefixo "SB", por isso que o Aeroporto de Fortaleza, Santos Dumont e Galeão possuem 
os códigos SBFZ, SBRJ e SBGL, respectivamente. Países com muitos aeroportos como os EUA, possuem
como prefixo a letra K, logo as três letras ficam livres, podendo assim terem mais códigos para uso.

\texttt{171300Z} significa que este METAR se refere ao dia 17 as 13 horas e zero minuto zulu. Horário
zulu é simplemente no fuso horário da longitude de zero grau, chamado de hora UTC ou 
Coordinated Universal Time. \cite{UTC} Para que não haja confusões com os horários, a aviação internacionalmente
usa o horário UTC. Este METAR, será válido até as 13:59,
quando será substituído pelo METAR iniciando com "SBFZ 171400Z".

Note que a seguinte expressão regular com três grupos de captura conseguem extrair o dia a hora e o minuto.

\begin{verbatim}
([0-9]{2})([0-9]{2})([0-9]{2})Z
\end{verbatim}

Com o METAR supracitado os grupos serão: 

\begin{itemize}
  \item Grupo 1 (dia): 17
  \item Grupo 2 (hora): 14
  \item Grupo 3 (minuto): 00
\end{itemize}

\texttt{15010KT} se refere a velocidade e direção do vento, os três primeiros algarismos a informam
a direção, em graus,
de onde o vento sopra e os últimos dois algarismos a velocidade do vento em nós (milhas
náuticas por hora). Neste caso o vento vem da direção 150 graus com velocidade de dez nós.
Com a expressão abaixo estraímos estas duas informações.

\begin{verbatim}
([0-9]{3})([0-9]{2})KT
\end{verbatim}

A informação de vento pode também conter a letra G (gust) para rajadas e a letra V
em um item separado para o caso de haver variação de direção. Por exemplo, um metar com os itens 
\texttt{10016G21KT 080V120} informa que há rajadas de
até 21kt e a direção do vento podendo variar de 80 à 120 graus. Existem outros aeroportos que podem usar 
outras unidades para a velocidade do vento, mas no Brasil só é usado apenas nós (kt). Para obter estas
informações usamos o regex \texttt{([0-9]\{3\}[0-9]\{2\}G{[0-9]\{2\}})} e \texttt{([0-9]\{3\})V([0-9]\{3\})}

\texttt{9999} Significa visibilidade ilimitada (maior ou igual a 10km). Se fosse 6000 a visibilidade 
seria de 6km. Por ser sempre quatro algarismos o regex \texttt{([0-9]\{4\})} consegue capturar esta informação.

\texttt{30/25} Temperatura 30°C e ponto de orvalho 25°C. Caso a temperatura seja negativa a letra M é adicionada
antes do número. M2/M5 significa temperatura -2°C e ponto de orvalho -5°C. \cite{METAR-help}

\texttt{Q1012} O altímetro do avião deve ser referenciado para 1012 hecto pascal. Também pode ser usada
a unidade polegadas de mercúrio (mmHg), mas no Brasil esta não é usada no METAR.

\texttt{SCT025} Nuvens espalhadas (3/8 a 4/8 do céu com nuvens) em 2500 pés de altitude. 025 se refere ao
nível de voo (Flight Level) que é a altitude acima do nível médio do mar com divisão exata por 100.

\texttt{FEW030TCU} Poucas nuvens (1/8 a 2/8 do céu com nuvens) em 3000 pés de altitude. O sufixo TCU siginica que
há nuvens convectivas significativas. \cite {decea-mil}

\texttt{BKN100} Nuvens broken (5/8 a 7/8 do céu com nuvens) em 10000 pés de altitude.

Existe também o tipo OVC (overcast) que se refere a totalmente encoberto.

\section {Algorítmo}

O objetivo do módulo de decoder é dar uma explicação semelhante a esta para qualquer tipo de METAR
de aeroportos no Brasil. O módulo usa várias expressões regulares para decodificar uma grande quantidade de informações,
porém não é exaustivo, foi dada a preferência a fenômenos que podem ocorrer no Brasil. Tirando o ICAO e a informação
do dia e hora, os itens de informação não possuem uma ordem fixa.

O algorítmo deve separar a string do METAR pelo caractere de espaço. Para cada item separado,
cada expressão regular é testada, caso uma combinação ocorra, os grupos de capturasão interpolados
em uma string que explica aquele item. Por exemplo, se o item "27008G16KT" é encontrado pela
expressão \texttt{([0-9]\{3\})([0-9]\{2\})G([0-9]\{2\})KT} e a string a ser interpolada é
\texttt{Vento \$1° com \$2 nós e rajadas de até \$3 nós}, será gerada uma tupla
\texttt{(27008G16KT, Vento 270° com 8 nós e rajadas de até 16 nós)}. O retorno do 
algorítmo será uma lista de tuplas que serão enviar para o front-end.